<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Auto Invoice Creator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* New Dark Theme Variables based on homepage.html */
      :root {
        --primary-color: #6366f1; /* Indigo-500 for buttons/accents */
        --primary-light: #818cf8; /* Indigo-400 for hover */
        --accent-color: #10b981; /* Emerald-500 for success/add */
        --danger-color: #ef4444; /* Red-500 for remove */
        --text-color: #d1d5db; /* Gray-300 for main text */
        --light-bg: #1f2937; /* Gray-800 for the main container background */
        --page-bg: #111827; /* Gray-900 for the body background */
        --border-color: #374151; /* Gray-700 for borders */
        --header-color: #f3f4f6; /* Gray-100 for headers */
      }

      body {
        font-family: "Inter", Arial, sans-serif;
        background: var(--page-bg);
        padding: 20px;
        margin: 0;
        color: var(--text-color);
      }

      .goo {
        /* This class is used for the Payment Details inputs */
        background: var(--page-bg); /* Darker input background */
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        color: var(--text-color);
      }

      .container {
        max-width: 960px;
        margin: auto;
        background: var(--light-bg);
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow for dark mode */
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: var(--header-color);
        font-weight: 800;
        font-size: 2.5rem;
        letter-spacing: -0.5px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 15px;
      }

      label {
        font-weight: 600;
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-size: 0.95rem;
        color: var(--header-color);
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      input[type="date"],
      .service-row input:not(.goo) {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
        background-color: var(--page-bg); /* Dark input background */
        color: var(--text-color);
      }

      input[type="text"]:focus,
      input[type="email"]:focus,
      input[type="number"]:focus,
      input[type="date"]:focus,
      .service-row input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Indigo focus glow */
        outline: none;
      }

      h3 {
        margin-top: 30px;
        color: var(--header-color);
        border-left: 4px solid var(--primary-color);
        padding-left: 10px;
      }

      /* Services Layout */
      .services-header {
        display: grid;
        grid-template-columns: 1fr 120px 120px 120px 40px;
        gap: 20px;
        align-items: center;
        margin-top: 20px;
        padding: 10px 0;
        border-bottom: 2px solid var(--primary-color);
        font-weight: 700;
        color: var(--header-color);
        text-transform: uppercase;
        font-size: 0.85rem;
      }
      .service-row {
        display: grid;
        grid-template-columns: 1fr 120px 120px 120px 40px;
        gap: 20px;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.1s;
      }
      .service-row:hover {
        background-color: #2a3545; /* Slightly lighter gray-800 on hover */
      }

      .service-row input {
        margin: 0;
      }

      .service-row input.unit-price,
      .service-row input.quantity,
      .service-row input.sub-display,
      .services-header > div:nth-child(2),
      .services-header > div:nth-child(3),
      .services-header > div:nth-child(4) {
        text-align: right;
      }

      /* Buttons */
      #add-service,
      #submit {
        padding: 12px 20px;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }

      #submit {
        background: var(--primary-color);
        width: 100%;
        display: block;
      }
      #submit:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
        box-shadow: 0 6px 10px rgba(99, 102, 241, 0.3);
      }
      #add-service {
        background: var(--accent-color);
        display: inline-block;
      }
      #add-service:hover {
        background: #059669; /* Darker emerald */
        box-shadow: 0 6px 10px rgba(16, 185, 129, 0.3);
      }
      .remove-btn {
        background: var(--danger-color);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        line-height: 1;
        padding: 0;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s;
      }
      .remove-btn:hover {
        background: #b91c1c; /* Darker red */
      }

      /* Totals and Bank Info Layout */
      .totals {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 40px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
      }

      .totals .right {
        /* Subtotal/Tax/Total Section - styled as a distinct box */
        background: #2a3545; /* Darker light-bg for contrast */
        padding: 20px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
      }
      .totals .right input[readonly] {
        background: var(--page-bg); /* Darkest background for read-only */
        font-weight: 600;
        color: var(--header-color);
        border-color: #4b5563; /* Gray-600 border */
      }
      .totals .right label strong {
        font-size: 1.1rem;
        color: var(--primary-light); /* Lighter indigo for emphasis */
      }
      #displayTotal {
        background-color: #4338ca !important; /* Deep Indigo background for emphasis */
        font-size: 1.2rem;
        font-weight: 700 !important;
        color: var(--header-color) !important;
      }

      /* Ensure bank info inputs take up full width and stack vertically */
      .bank-info label,
      .bank-info input {
        width: 100%;
        display: block;
      }

      #status {
        margin-top: 20px;
        padding: 10px;
        text-align: center;
        color: var(--primary-light);
        font-weight: 600;
        border: 1px solid var(--primary-light);
        border-radius: 8px;
        background-color: #312e81; /* Dark purple background for status */
        /* HIDE THE BOX BY DEFAULT */
        display: none;
      }

      /* Responsive Adjustments */
      @media (max-width: 900px) {
        .totals {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 700px) {
        .services-header,
        .service-row {
          grid-template-columns: 1fr 80px 80px 80px 40px;
          gap: 10px;
        }
        .container {
          padding: 20px;
          margin: 10px;
        }
      }

      /* Home Button Styling */
      .home-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9em;
        transition: background-color 0.3s ease, transform 0.1s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .home-btn:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="home-btn">‚Üê Home</a>
    <div class="container">
      <h1>Invoice Creator</h1>

      <label for="issuedTo">Issued To:</label>
      <input id="issuedTo" type="text" placeholder="Client Name or Company" />

      <label for="email">Client Email:</label>
      <input id="email" type="email" placeholder="client@example.com" />

      <label for="invoiceNumber">Invoice Number:</label>
      <input id="invoiceNumber" type="text" placeholder="INV-2025-001" />

      <label for="date">Invoice Date:</label>
      <input id="date" type="date" />

      <h3>Services Rendered</h3>

      <div class="services-header">
        <div><strong>Description</strong></div>
        <div><strong>Unit Price</strong></div>
        <div><strong>Quantity</strong></div>
        <div><strong>Subtotal</strong></div>
        <div></div>
      </div>

      <div id="services"></div>

      <button id="add-service">+ Add Service</button>

      <div class="totals">
        <div class="box bank-info">
          <h3>Payment Details</h3>

          <label for="bankName">Bank Name:</label>
          <input class="goo" id="bankName" placeholder="e.g. Bank of Finance" />

          <label for="accountName">Account Name:</label>
          <input
            class="goo"
            id="accountName"
            placeholder="Your Business Name"
          />

          <label for="bsb">BSB (Sort Code):</label>
          <input class="goo" id="bsb" placeholder="123-456" />

          <label for="accountNumber">Account Number:</label>
          <input class="goo" id="accountNumber" placeholder="789012345" />
        </div>

        <div class="right">
          <label for="displaySubtotal">Subtotal:</label>
          <input id="displaySubtotal" type="text" readonly />

          <label for="taxRate">Tax Rate (%):</label>
          <input
            id="taxRate"
            type="number"
            step="0.01"
            placeholder="e.g. 8.25"
            value="0.00"
          />

          <label for="displayTaxAmount">Tax Amount:</label>
          <input id="displayTaxAmount" type="text" readonly />

          <label for="displayTotal"><strong>Total Due:</strong></label>
          <input id="displayTotal" type="text" readonly />
        </div>
      </div>

      <button id="submit">Generate and Send Invoice</button>

      <div id="status"></div>
    </div>

    <script>
      // CONFIG: max columns your sheet expects (we will always send up to this many service slots)
      const MAX_SERVICES = 10;

      const servicesContainer = document.getElementById("services");
      const addServiceBtn = document.getElementById("add-service");
      const submitBtn = document.getElementById("submit");
      const displaySubtotal = document.getElementById("displaySubtotal");
      const displayTaxAmount = document.getElementById("displayTaxAmount");
      const displayTotal = document.getElementById("displayTotal");
      const taxRateInput = document.getElementById("taxRate");
      const statusEl = document.getElementById("status"); // Get status element here

      // create a service input row element
      function createServiceRow(name = "", price = "", qty = "") {
        const row = document.createElement("div");
        row.className = "service-row";

        // description
        const desc = document.createElement("input");
        desc.type = "text";
        desc.className = "service-name";
        desc.placeholder = "Service description";
        desc.value = name;

        // price
        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.step = "0.01";
        priceInput.className = "unit-price";
        priceInput.placeholder = "0.00";
        priceInput.value = price;
        priceInput.style.textAlign = "right";

        // qty
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.step = "1";
        qtyInput.className = "quantity";
        qtyInput.placeholder = "0";
        qtyInput.value = qty;
        qtyInput.style.textAlign = "right";

        // subtotal display (read-only)
        const subDisplay = document.createElement("input");
        subDisplay.type = "text";
        subDisplay.className = "sub-display";
        subDisplay.readOnly = true;
        subDisplay.value = "0.00";
        subDisplay.style.textAlign = "right";

        // remove button
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-btn";
        removeBtn.innerHTML = "&times;"; // Using an X symbol
        removeBtn.onclick = () => {
          row.remove();
          recalcAll();
        };

        // update subtotal whenever price or qty changes
        function updateRowSubtotal() {
          const p = parseFloat(priceInput.value) || 0;
          const q = parseFloat(qtyInput.value) || 0;
          const s = +(p * q).toFixed(2);
          subDisplay.value = s.toFixed(2);
          recalcAll();
        }

        priceInput.addEventListener("input", updateRowSubtotal);
        qtyInput.addEventListener("input", updateRowSubtotal);

        // assemble row
        row.appendChild(desc);
        row.appendChild(priceInput);
        row.appendChild(qtyInput);
        row.appendChild(subDisplay);
        row.appendChild(removeBtn);

        servicesContainer.appendChild(row);

        return row;
      }

      function recalcAll() {
        // calculate subtotal from all service rows
        const rows = Array.from(document.querySelectorAll(".service-row"));
        let subtotal = 0;
        rows.forEach((r) => {
          const p = parseFloat(r.querySelector(".unit-price").value) || 0;
          const q = parseFloat(r.querySelector(".quantity").value) || 0;
          const s = +(p * q);
          subtotal += s;
          // update sub-display (in case JS changed data)
          const subDisp = r.querySelector(".sub-display");
          if (subDisp) subDisp.value = s.toFixed(2);
        });

        subtotal = +subtotal.toFixed(2);
        displaySubtotal.value = subtotal.toFixed(2);

        // tax
        const taxRate = parseFloat(taxRateInput.value) || 0;
        const taxAmount = +(subtotal * (taxRate / 100));
        displayTaxAmount.value = taxAmount.toFixed(2);

        const total = +(subtotal + taxAmount);
        displayTotal.value = total.toFixed(2);
      }

      // add initial row
      createServiceRow();
      recalcAll();

      addServiceBtn.onclick = () => {
        // Prevent adding more rows than MAX_SERVICES allows
        if (servicesContainer.children.length >= MAX_SERVICES) {
          // FIX: Replaced invalid JS syntax 'var(--danger-color)' with hex code '#ef4444'
          statusEl.style.display = "block";
          statusEl.style.backgroundColor = "#ef4444";
          statusEl.style.color = "white";
          statusEl.innerText = `You can only add up to ${MAX_SERVICES} services.`;
          setTimeout(() => {
            statusEl.style.display = "none";
          }, 3000); // Hide after 3 seconds
          return;
        }
        createServiceRow();
        recalcAll();
      };

      // recalc when tax rate changes
      taxRateInput.addEventListener("input", recalcAll);

      // HELPER to safely get service values up to MAX_SERVICES
      function collectServicesPayload() {
        const rows = Array.from(document.querySelectorAll(".service-row"));
        const payload = {};
        for (let i = 0; i < MAX_SERVICES; i++) {
          const idx = i; // 0-based
          const slot = i + 1; // 1-based service number
          if (idx < rows.length) {
            const r = rows[idx];
            const name = r.querySelector(".service-name").value || "";
            const price = parseFloat(r.querySelector(".unit-price").value) || 0;
            const qty = parseFloat(r.querySelector(".quantity").value) || 0;
            const sub = +(price * qty).toFixed(2);
            payload[`service${slot}_name`] = name;
            payload[`service${slot}_price`] = price.toFixed(2);
            payload[`service${slot}_qty`] = qty;
            payload[`service${slot}_sub`] = sub.toFixed(2);
          } else {
            // ensure empty values for missing slots so your sheet stays consistent
            payload[`service${slot}_name`] = "";
            payload[`service${slot}_price`] = "";
            payload[`service${slot}_qty`] = "";
            payload[`service${slot}_sub`] = "";
          }
        }
        return payload;
      }

      submitBtn.onclick = async () => {
        // gather form-level fields
        const issuedTo = document.getElementById("issuedTo").value || "";
        const email = document.getElementById("email").value || "";
        const invoiceNumber =
          document.getElementById("invoiceNumber").value || "";
        const date = document.getElementById("date").value || "";
        const bankName = document.getElementById("bankName").value || "";
        const accountName = document.getElementById("accountName").value || "";
        const bsb = document.getElementById("bsb").value || "";
        const accountNumber =
          document.getElementById("accountNumber").value || "";

        // recalc to ensure displays are current
        recalcAll();

        const subtotal = parseFloat(displaySubtotal.value) || 0;
        const taxRate = parseFloat(taxRateInput.value) || 0;
        const taxAmount = +(subtotal * (taxRate / 100));
        const total = +(subtotal + taxAmount);

        // basic validation
        if (!issuedTo || !email || !invoiceNumber) {
          // FIX: Replaced invalid JS syntax 'var(--danger-color)' with hex code '#ef4444'
          statusEl.style.display = "block";
          statusEl.style.backgroundColor = "#ef4444";
          statusEl.style.color = "white";
          statusEl.innerText =
            "Please fill in Client Name, Email, and Invoice Number.";
          setTimeout(() => {
            statusEl.style.display = "none";
          }, 5000);
          return;
        }

        // build payload
        const payload = {
          issuedTo,
          email,
          invoiceNumber,
          date,
          bankName,
          accountName,
          bsb,
          accountNumber,
          subtotal: subtotal.toFixed(2),
          tax: taxRate.toFixed(2),
          taxAmount: taxAmount.toFixed(2),
          total: total.toFixed(2),
        };

        // include services up to MAX_SERVICES
        const servicesPayload = collectServicesPayload();
        Object.assign(payload, servicesPayload);

        // **SHOW STATUS BOX AND SET INITIAL TEXT**
        statusEl.style.display = "block";
        statusEl.style.backgroundColor = "#312e81"; /* Consistent background */
        statusEl.style.color = "#818cf8"; // Using the primary-light color
        statusEl.innerText = "Sending invoice...";

        // Use exponential backoff for API calls
        const maxRetries = 3;
        let retryDelay = 1000;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
          try {
            const res = await fetch(
              "https://hook.us2.make.com/mgj3n3akl1cd4g65nkt7csl2m62ptvef",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );

            if (res.ok) {
              statusEl.innerText = "Invoice submitted successfully!";
              // You might want to clear the status after a delay
              // setTimeout(() => statusEl.style.display = 'none', 5000);
              return; // Success, exit function
            } else if (res.status === 429 || res.status >= 500) {
              // Log error and retry if server error or too many requests
              if (attempt < maxRetries - 1) {
                statusEl.innerText = `Sending failed. Retrying in ${
                  retryDelay / 1000
                }s...`;
                await new Promise((resolve) => setTimeout(resolve, retryDelay));
                retryDelay *= 2; // Exponential backoff
                continue; // Move to the next attempt
              } else {
                // Max retries reached
                const text = await res.text();
                statusEl.innerText = `Error sending invoice after ${maxRetries} attempts: ${res.status} ${text}`;
                break;
              }
            } else {
              // Client error (4xx) - no need to retry
              const text = await res.text();
              statusEl.innerText = `Error sending invoice: ${res.status} ${text}`;
              break;
            }
          } catch (err) {
            // Network error - retry
            if (attempt < maxRetries - 1) {
              statusEl.innerText = `Network issue. Retrying in ${
                retryDelay / 1000
              }s...`;
              await new Promise((resolve) => setTimeout(resolve, retryDelay));
              retryDelay *= 2; // Exponential backoff
              continue;
            } else {
              statusEl.innerText = "Network error: " + err.message;
              break;
            }
          }
        }
      };
    </script>
  </body>
</html>
